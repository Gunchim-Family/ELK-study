## 엘라스틱서치 기본

### cat API
`compact and aligned text`의 약어..
클러스터, 노드, 인덱스 정보 등을 얻는 경우 사용하는 API

```
// 인덱스 목록 조회 
GET _cat/indices?v 

// 샤드 상태 확인 
GET /_cat/shards?v

// 노드 정보 확인 
GET /_cat/nodes?v
```


### 인덱스와 도큐먼트

- 인덱스 :
    - 도큐먼트를 저장하는 논리적 단위로 RDB의 테이블에 해당하는 개념이다.
    - 인덱스 이름의 경우 영어 소문자만 사용 가능하다.
    - `\ / * ? “ < > | # , <공백>` 특수문자는 사용불가
    - 255 바이트 보다 길게 지을 수 없다.
    - 인덱스는 용량이나 숫자 제한이 없어 무한대의 도큐먼트를 추가할 수 있다.
    - 하지만 인덱스의 크기가 커지면 검색 성능이 나빠지기 때문에 특정 용량, 날짜 단위 등으로 인덱스를 그루핑 하는 것이 좋다.
- 도큐먼트 :
    - ES에서 데이터가 저장되는 기본 단위로 JSON형태로 key:value 형태로 저장된다.
    - RDB의 레코드에 해당하는 개념이다.
    ```
    // 아래와 같이 Json타입으로 구성된다.
    {
    "title": "제목1",
    "content": "내용1",
    "created_at": "2024-07-22"
    }
    ```
ES7 버전 부터는 타입이 사라지면서 RDB와 1대1 비교가 힘들어졌다.

### CRUD
- ES에서 도큐먼트를 인덱스에 포함시키는 것을 인덱싱이라고 한다.
- ES에서는 도큐먼트 수정은 비용이 많이 들기 때문에 사용하지 않는 것이 좋다.

1. 생성
- PUT 메서드 : `인덱스/_doc/<도큐먼트id>`(숫자)
2. 조회
- GET 메서드 : -> 단건 조회 : `인덱스/_doc/<도큐먼트id>` 
- 여러건 조회 : `인덱스/_search` 
3. 삭제
- DELETE 메서드 : `인덱스/_doc/<도큐먼트id>`
4. 수정
- POST 메서드 : POST 메서드 `<인덱스>/_doc` -> 임의의 도큐먼트 id 생성됨
- _update : `인덱스/_update/<도큐먼트 id>` , 업데이트 할 내용에 "doc" 이라는 지정자를 사용 
```
// _update API 예시 
POST my_index/_update/1
{
"doc": {
 "message":"안녕하세요 Kibana"
 }
}
```

#### PUT과 POST의 차이 
- PUT 
  - 도큐먼트 ID를 명시적으로 지정하여 생성한다.
  - 같은 ID의 도큐먼트가 존재하면 덮어쓰고, 없으면 새로 생성한다. 
  - 같은 도큐먼트 아이디를 덮어쓰는 것이 마치 UPDATE하는 것과 유사하다. (REST API 결과도 updated를 응답한다.)
- POST 
  - 도큐먼트 ID를 자동으로 생성한다. 
  - 도큐먼트의 일부 필드 수정과 같이 부분적으로 수정할 때 사용한다. 
도큐먼트 생성시 PUT메서드를 사용하면 ID값 충돌 및 기존 ID의 데이터를 덮어 쓸 위험이 있으므로 POST 메서드 사용이 추천된다.

### 매핑

- RDB의 테이블의 스키마처럼 ES에서도 매핑을 통해 인덱스의 데이터 형태를 정의할 수 있다.
- 다이나믹 매핑
    - 기본적으로 인덱스에 대한 매핑을 설정하지 않아도 도큐먼트는 인덱싱이 된다.
    - 이는 다이나믹 매핑 덕분이며, JSON 도큐먼트 데이터 타입에 따라 ES가 자동으로 인덱스 매핑을 해준다.
- 명시적 매핑
    - 인덱스 매핑을 직접 정의할 때 사용한다.
    - 인덱스 생성시 mappings를 정의하거나 mapping API를 사용한다.
    - 인덱스 매핑이 정해진 경우 새로운 필드를 추가는 가능하지만, 기존의 필드를 수정&삭제는 불가능하다.
    - 만약 필드 변경하거나 데이터 타입을 변경하려면 새로운 인덱스를 만들거나 reindex API를 사용해야 한다.
- 매핑 타입
    - 명시적 매핑을 정의하기 위한 데이터 타입
    - RDB에서 컬럼 타입 및 크기 설정이 성능과 밀접한 연관이 있는 것처럼, 매핑 타입 역시 잘 사용하면 인덱스 성능을 올릴 수 있다.
    - 텍스트
        - `text` : 분석기에 의해 텍스트를 토큰화하여 역색인에 저장한다. 역 인덱스에 저장된 토큰들을 용어(term)이라고 불린다. 
        - `keyword` :분석기를 거치지 않고 전체 값이 저장되며, 효율적인 정렬 및 집계 시 사용
            - “beautiful day”라는 문자열이 있는 경우
            - text 타입은 \[beautiful, day\] 2개의 term으로 저장된다.
            - keyword 타입은 \[beautiful day\] 하나의 term으로 저장된다. text 타입에 비해 부분 일치 검색을 힘들지만 집계나 정렬 시 유용하게 사용할 수 있다.
    - 날짜
        - `date`
    - 정수
        - `byte, shrt, integer, long`
    - 실수

        - `scaled_float, half_float, double, flot`

  
### 인덱스 템플릿
- 주로 동일한 복수의 인덱스를 만들 때 사용한다. 

- 매핑과 인덱스 템플릿 차이 
  - 범위 
    - 매핑 : 특정 인덱스에만 적용된다. 
    - 인덱스 템플릿 : 여러 인덱스에 적용할 설정과 매핑을 정의한다. 인덱스 이름 패턴에 맞는 모든 인덱스에 자동으로 적용된다. 
  - 활용 
    - 매핑 : 생성할 때 또는 이미 존재하는 인덱스에 적용할 때 사용
    - 인덱스 템플릿 : 새로운 인덱스가 생성될 때, 지정된 패턴에 맞는 인덱스에 자동으로 설정을 적용하기 위해 사용



